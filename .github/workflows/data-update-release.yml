name: æ•°æ®æ›´æ–°å‘å¸ƒ (Data Update Release)

on:
  repository_dispatch:
    types: [data-updated] # ç”±ç±»å‹ä¸º data-updated çš„å¤–éƒ¨äº‹ä»¶è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      # åŸºäº 'data-update' å’Œä¼ å…¥çš„æäº¤SHAï¼ˆå¦‚æœå¯ç”¨ï¼‰ç»„åˆå¹¶å‘ç»„
      # æˆ–è€…å¦‚æœSHAç¼ºå¤±ï¼Œåˆ™å›é€€åˆ° run_id ä»¥ç¡®ä¿å”¯ä¸€çš„ç»„åã€‚
      group: release-data-update-${{ github.event.client_payload.b_commit_sha || github.run_id }}
      cancel-in-progress: true

    steps:
      - name: Checkout æœ¬ä»“åº“ä»£ç  (mainåˆ†æ”¯)
        uses: actions/checkout@v4
        with:
          # å¯¹äºæ•°æ®æ›´æ–°ï¼Œé€šå¸¸å¸Œæœ›å°†å®ƒä»¬åº”ç”¨åˆ°ä½ çš„ä¸»/æœ€æ–°ä»£ç åº“
          ref: 'main'

      - name: å¤åˆ¶ä¸»ä»“åº“çš„JSONæ–‡ä»¶åˆ°ç›®æ ‡ç›®å½• (masterTrans)
        run: |
          mkdir -p gakumas-local/local-files/masterTrans
          # å‡è®¾ 'data/*.json' æ˜¯ä½ ä»“åº“æ•°æ®ç›®å½•ä¸­çš„æ–‡ä»¶
          if ls data/*.json 1> /dev/null 2>&1; then
            cp -r data/*.json gakumas-local/local-files/masterTrans/
            echo "å·²ä»æœ¬åœ° data/ ç›®å½•å¤åˆ¶JSONæ–‡ä»¶åˆ° gakumas-local/local-files/masterTrans/"
          else
            echo "æœ¬åœ° data/ ç›®å½•ä¸­æœªæ‰¾åˆ°å¯å¤åˆ¶çš„JSONæ–‡ä»¶ã€‚"
          fi
          tree gakumas-local -L 3

      - name: ä»Dispatch Payloadä¸­æå–Bä»“åº“æäº¤ä¿¡æ¯
        id: extract_b_info
        # æ­¤æ­¥éª¤ä»…åœ¨äº‹ä»¶ä¸º repository_dispatch æ—¶è¿è¡Œï¼Œè¿™å¯¹äºæ­¤å·¥ä½œæµå°†æ˜¯å¦‚æ­¤
        run: |
          echo "æ­£åœ¨ä» client_payload ä¸­æå–ä¿¡æ¯..."
          echo "Payload b_commit_sha: ${{ github.event.client_payload.b_commit_sha }}"
          echo "Payload b_commit_msg: ${{ github.event.client_payload.b_commit_msg }}"

          if [ -z "${{ github.event.client_payload.b_commit_sha }}" ]; then
            echo "é”™è¯¯ï¼šclient_payload ä¸­ç¼ºå°‘ b_commit_shaã€‚"
            # exit 1 # å¦‚æœç¼ºå°‘åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥é€‰æ‹©ä½¿ä½œä¸šå¤±è´¥
          fi
          if [ -z "${{ github.event.client_payload.b_commit_msg }}" ]; then
            echo "è­¦å‘Šï¼šclient_payload ä¸­ç¼ºå°‘ b_commit_msgã€‚"
            # åœ¨æ²¡æœ‰æ¶ˆæ¯çš„æƒ…å†µä¸‹ç»§ç»­å¯èƒ½æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥è®©å®ƒå¤±è´¥
          fi

          echo "B_COMMIT_SHA=${{ github.event.client_payload.b_commit_sha }}" >> $GITHUB_OUTPUT
          # ä½¿ç”¨æ›´ç¨³å¥çš„æ–¹å¼å¤„ç†å¤šè¡Œæäº¤æ¶ˆæ¯
          echo "B_COMMIT_MSG<<EOF_MSG" >> $GITHUB_OUTPUT
          echo "${{ github.event.client_payload.b_commit_msg }}" >> $GITHUB_OUTPUT
          echo "EOF_MSG" >> $GITHUB_OUTPUT
          # å‡è®¾æ­¤å·¥ä½œæµçš„æºä»“åº“å§‹ç»ˆæ˜¯ Gakumas-Auto-Translate
          echo "B_REPO_URL=https://github.com/chihya72/Gakumas-Auto-Translate" >> $GITHUB_OUTPUT

      - name: å‡†å¤‡èµ„æºç›®å½• (resource)
        run: |
          rm -rf gakumas-local/local-files/resource/*
          mkdir -p gakumas-local/local-files/resource
          echo "å‡†å¤‡åçš„èµ„æºç›®å½•ç»“æ„:"
          tree gakumas-local/local-files -L 2

      - name: ä»Gakumas-Auto-Translateå…‹éš†æŒ‡å®šæäº¤çš„ç¿»è¯‘æ•°æ®
        # ä»…å½“ B_COMMIT_SHA æˆåŠŸæå–æ—¶è¿è¡Œ
        if: ${{ steps.extract_b_info.outputs.B_COMMIT_SHA != '' }}
        run: |
          echo "æ­£åœ¨ä» ${{ steps.extract_b_info.outputs.B_REPO_URL }} çš„æäº¤ ${{ steps.extract_b_info.outputs.B_COMMIT_SHA }} è·å–ç¿»è¯‘æ•°æ®"
          # å³ä½¿ç¨åé€šè¿‡ç¨€ç–æ£€å‡ºç‰¹å®šSHAï¼Œä½¿ç”¨ depth 1 ä»ç„¶æœ‰ç›Š
          git clone --filter=blob:none --no-checkout ${{ steps.extract_b_info.outputs.B_REPO_URL }}.git temp-repo
          cd temp-repo
          git sparse-checkout init --cone
          git sparse-checkout set data # åªå¯¹ 'data' ç›®å½•æ„Ÿå…´è¶£
          # æ£€å‡º dispatch payload ä¸­æä¾›çš„ç‰¹å®šæäº¤ SHA
          git checkout ${{ steps.extract_b_info.outputs.B_COMMIT_SHA }}
          cd ..
          echo "å…‹éš†çš„ temp-repo/data ä¸­çš„æ•°æ®æ–‡ä»¶ (æ¥è‡ªç‰¹å®šæäº¤):"
          find temp-repo/data -type f -print -quit | grep . && find temp-repo/data -type f | wc -l || echo "åœ¨ temp-repo/data ä¸­æœªæ‰¾åˆ°æ–‡ä»¶"

      - name: å¤åˆ¶ç¿»è¯‘æ•°æ®åˆ°resourceç›®å½•
        run: |
          if [ -d "temp-repo/data" ] && [ "$(ls -A temp-repo/data)" ]; then
            cp -R temp-repo/data/* gakumas-local/local-files/resource/
            echo "å·²ä» temp-repo/data å¤åˆ¶æ–‡ä»¶åˆ° gakumas-local/local-files/resource/:"
            find gakumas-local/local-files/resource -type f | wc -l
          else
            echo "åœ¨ temp-repo/data ä¸­æœªæ‰¾åˆ°å¯å¤åˆ¶çš„æ•°æ®æ–‡ä»¶ã€‚Resource ç›®å½•å¯èƒ½ä¸ºç©ºã€‚"
          fi
          rm -rf temp-repo # æ¸…ç†ä¸´æ—¶å…‹éš†

      - name: åˆ›å»ºZIPå‹ç¼©åŒ…
        run: |
          sudo apt-get update && sudo apt-get install -y zip unzip
          echo "æ–‡ä»¶æ•°é‡ç»Ÿè®¡ (æ‰“åŒ…å‰ resource):"
          find gakumas-local/local-files/resource -type f -print -quit | grep . && find gakumas-local/local-files/resource -type f | wc -l || echo "0 ä¸ªæ–‡ä»¶"
          echo "æ–‡ä»¶æ•°é‡ç»Ÿè®¡ (æ‰“åŒ…å‰ masterTrans):"
          find gakumas-local/local-files/masterTrans -type f -print -quit | grep . && find gakumas-local/local-files/masterTrans -type f | wc -l || echo "0 ä¸ªæ–‡ä»¶"

          zip -r gakumas-local.zip gakumas-local/ -x "*.git*" "*.github*"
          du -h gakumas-local.zip
          echo "éªŒè¯ ZIP å†…å®¹ (éƒ¨åˆ† resource):"
          unzip -l gakumas-local.zip | grep 'gakumas-local/local-files/resource/' | head -n 10 || echo "zipåŒ…ä¸­æ— resourceæ–‡ä»¶"
          echo "éªŒè¯ ZIP å†…å®¹ (éƒ¨åˆ† masterTrans):"
          unzip -l gakumas-local.zip | grep 'gakumas-local/local-files/masterTrans/' | head -n 10 || echo "zipåŒ…ä¸­æ— masterTransæ–‡ä»¶"

      - name: ä¸ºæ•°æ®æ›´æ–°ç”Ÿæˆå‘å¸ƒå…ƒæ•°æ®
        id: set_release_name
        run: |
          RAW_B_COMMIT_SHA="${{ steps.extract_b_info.outputs.B_COMMIT_SHA }}"
          SHORT_B_SHA=${RAW_B_COMMIT_SHA:0:7}
          RAW_B_MSG="${{ steps.extract_b_info.outputs.B_COMMIT_MSG }}"
          B_REPO_URL="${{ steps.extract_b_info.outputs.B_REPO_URL }}"
          B_REPO_NAME=$(basename $B_REPO_URL)

          COMMIT_URL_B="${B_REPO_URL}/commit/${RAW_B_COMMIT_SHA}"

          # ä½¿ç”¨å›ºå®šçš„æ ‡ç­¾å - ä¿®æ­£äº†æ‹¼å†™é”™è¯¯
          FIXED_PRE_RELEASE_TAG="latest-Translate-Data-update"
          echo "release_tag_name=${FIXED_PRE_RELEASE_TAG}" >> $GITHUB_OUTPUT

          # Release çš„æ ‡é¢˜ä»ç„¶å¯ä»¥åŠ¨æ€æ›´æ–°ï¼Œä»¥åæ˜ æœ€æ–°çš„Bä»“åº“æäº¤
          echo "name=${B_REPO_NAME}@${SHORT_B_SHA} (Data Update)" >> $GITHUB_OUTPUT
          
          echo "body<<EOF_BODY" >> $GITHUB_OUTPUT
          echo "**ğŸ”„ æœ€æ–°æ•°æ®æ›´æ–° - $(date -u '+%Y-%m-%d %H:%M:%S UTC')**" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**ç”± [${B_REPO_NAME}](${B_REPO_URL}) ä¸­çš„æäº¤è§¦å‘:**" >> $GITHUB_OUTPUT
          echo "- æäº¤: [${SHORT_B_SHA}](${COMMIT_URL_B})" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**æ¥è‡ªæº (${B_REPO_NAME}) çš„å®Œæ•´æäº¤ä¿¡æ¯:**" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "${RAW_B_MSG}" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "*âš¡ æ­¤é¢„å‘å¸ƒåŒ…å«æ¥è‡ªæºä»“åº“çš„æœ€æ–°æ•°æ®ï¼Œä¼šè‡ªåŠ¨ä¿æŒåœ¨é¡¶éƒ¨ä½ç½®ã€‚*" >> $GITHUB_OUTPUT
          echo "EOF_BODY" >> $GITHUB_OUTPUT

      - name: åˆ é™¤ç°æœ‰çš„æ•°æ®æ›´æ–° release
        continue-on-error: true # å¦‚æœæ²¡æœ‰ç°æœ‰ release ä¹Ÿç»§ç»­æ‰§è¡Œ
        run: |
          RELEASE_TAG="${{ steps.set_release_name.outputs.release_tag_name }}"
          echo "å°è¯•åˆ é™¤ç°æœ‰çš„ release: ${RELEASE_TAG}"
          
          # ä½¿ç”¨ GitHub CLI åˆ é™¤ releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          gh release delete "${RELEASE_TAG}" --yes || echo "æ²¡æœ‰æ‰¾åˆ°ç°æœ‰çš„ release æˆ–åˆ é™¤å¤±è´¥ï¼Œç»§ç»­åˆ›å»ºæ–°çš„"
          
          # åˆ é™¤ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git push origin --delete "${RELEASE_TAG}" || echo "æ²¡æœ‰æ‰¾åˆ°ç°æœ‰çš„ tag æˆ–åˆ é™¤å¤±è´¥"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»ºæ•°æ®æ›´æ–°å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          files: gakumas-local.zip
          name: ${{ steps.set_release_name.outputs.name }}
          body: ${{ steps.set_release_name.outputs.body }}
          # ä¸ºè¿™äº›æ•°æ®æ›´æ–°ä½¿ç”¨å›ºå®šçš„æ ‡ç­¾å
          tag_name: ${{ steps.set_release_name.outputs.release_tag_name }}
          draft: false          # æ ‡è®°ä¸ºé¢„å‘å¸ƒï¼Œé€‚ç”¨äºè‡ªåŠ¨åŒ–çš„æ•°æ®è§¦å‘å‘å¸ƒ
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}